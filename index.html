<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DrawMyInfra</title>
<style>
  :root {
    --primary:     #2DC4B8;
    --primary-dk:  #22A89E;
    --brand-dark:  #1C2E44;
    --bg:          #EEF4F8;
    --card:        #FFFFFF;
    --border:      #D0DAE6;
    --text:        #2D3748;
    --muted:       #64748B;
    --drop-hover:  #E3F5F4;
    --input-bg:    #FFFFFF;
    --code-bg:     rgba(0,0,0,.06);
  }
  @media (prefers-color-scheme: dark) {
    :root:not([data-theme="light"]) {
      --brand-dark:  #C8DFF0;
      --bg:          #0C1520;
      --card:        #152030;
      --border:      #243550;
      --text:        #CBD5E0;
      --muted:       #64748B;
      --drop-hover:  #0E2030;
      --input-bg:    #1A2C40;
      --code-bg:     rgba(255,255,255,.08);
    }
  }
  :root[data-theme="dark"] {
    --brand-dark:  #C8DFF0;
    --bg:          #0C1520;
    --card:        #152030;
    --border:      #243550;
    --text:        #CBD5E0;
    --muted:       #64748B;
    --drop-hover:  #0E2030;
    --input-bg:    #1A2C40;
    --code-bg:     rgba(255,255,255,.08);
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 40px 20px 80px;
    transition: background-color .3s, color .3s;
  }
  header { text-align: center; margin-bottom: 40px; }
  .logo-img { height: 180px; width: auto; margin-bottom: 4px; }
  .subtitle { color: var(--muted); font-size: 0.95rem; }
  .card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 16px; padding: 32px;
    width: 100%; max-width: 680px;
    box-shadow: 0 2px 16px rgba(0,0,0,.07);
  }
  .drop-zone {
    border: 2.5px dashed var(--border); border-radius: 12px;
    padding: 40px 24px; text-align: center; cursor: pointer;
    transition: border-color .2s, background .2s;
  }
  .drop-zone:hover, .drop-zone.drag-over {
    border-color: var(--primary); background: var(--drop-hover);
  }
  .drop-icon { font-size: 2.5rem; margin-bottom: 10px; }
  .drop-text { font-size: 1rem; color: var(--muted); }
  .drop-text strong { color: var(--primary); cursor: pointer; }
  #file-input { display: none; }
  #file-list { margin-top: 24px; display: flex; flex-direction: column; gap: 10px; }
  .file-row {
    display: flex; align-items: center; gap: 10px;
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 14px;
  }
  .file-icon { font-size: 1.4rem; }
  .file-name {
    flex: 1; font-size: 0.9rem; font-weight: 600; color: var(--brand-dark);
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .site-input {
    border: 1px solid var(--border); border-radius: 6px;
    padding: 4px 10px; font-size: 0.85rem; width: 130px;
    color: var(--text); background: var(--input-bg);
    outline: none; transition: border-color .2s, background .3s;
  }
  .site-input:focus { border-color: var(--primary); }
  .remove-btn {
    background: none; border: none; cursor: pointer;
    font-size: 1.1rem; color: var(--muted); transition: color .15s;
  }
  .remove-btn:hover { color: #e53e3e; }
  #vcf9-option {
    display: flex; align-items: center; gap: 8px;
    margin-top: 18px; font-size: 0.9rem; color: var(--text);
    cursor: pointer; user-select: none;
  }
  #vcf9-option input { accent-color: var(--primary); width: 16px; height: 16px; cursor: pointer; }
  .btn {
    display: block; width: 100%; margin-top: 28px;
    padding: 14px 0; font-size: 1rem; font-weight: 700;
    background: var(--primary); color: #fff;
    border: none; border-radius: 10px; cursor: pointer;
    transition: background .2s, transform .1s; letter-spacing: .3px;
  }
  .btn:hover:not(:disabled) { background: var(--primary-dk); transform: translateY(-1px); }
  .btn:disabled { background: var(--border); color: var(--muted); cursor: not-allowed; transform: none; }
  #status {
    margin-top: 18px; text-align: center;
    font-size: 0.9rem; min-height: 22px;
  }
  .err { color: #e53e3e; }
  .ok  { color: #2d8a4e; font-weight: 600; }
  .spinner {
    display: inline-block; width: 16px; height: 16px;
    border: 2px solid var(--border); border-top-color: var(--primary);
    border-radius: 50%; animation: spin .7s linear infinite;
    vertical-align: middle; margin-right: 6px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #preview-section {
    width: 100%; max-width: 1300px;
    margin-top: 32px;
  }
  .preview-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 12px;
  }
  .preview-header h2 { font-size: 1.1rem; font-weight: 700; color: var(--brand-dark); }
  .btn-outline {
    padding: 8px 20px; font-size: 0.9rem; font-weight: 600;
    background: transparent; color: var(--primary);
    border: 2px solid var(--primary); border-radius: 8px;
    cursor: pointer; transition: background .2s, color .2s;
  }
  .btn-outline:hover { background: var(--primary); color: #fff; }
  #excalidraw-mount {
    height: 620px; border-radius: 12px; overflow: hidden;
    box-shadow: 0 2px 16px rgba(0,0,0,.10);
    border: 1px solid var(--border);
  }
  footer {
    margin-top: 40px; font-size: 0.8rem; color: var(--muted); text-align: center;
  }
  footer a { color: var(--primary); text-decoration: none; }
  footer code { background: var(--code-bg); padding: 1px 5px; border-radius: 4px; }
  .theme-toggle {
    background: none; border: 1px solid var(--border); border-radius: 6px;
    cursor: pointer; padding: 3px 8px; font-size: 0.85rem;
    color: var(--muted); margin-left: 10px; vertical-align: middle;
    transition: border-color .2s, color .2s;
  }
  .theme-toggle:hover { border-color: var(--primary); color: var(--primary); }
</style>
</head>
<body>
<header>
  <img src="logo.png" alt="DrawMyInfra" class="logo-img"/>
  <p class="subtitle">Upload <strong>RVTools</strong> or <strong>LiveOptics</strong> .xlsx exports ‚Äî get a ready-to-open infrastructure diagram</p>
</header>

<div class="card">
  <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
    <div class="drop-icon">üìÇ</div>
    <p class="drop-text">Drop your <strong>RVTools</strong> or <strong>LiveOptics</strong> .xlsx files here<br>or <strong>click to browse</strong></p>
  </div>
  <input type="file" id="file-input" accept=".xlsx" multiple/>
  <div id="file-list"></div>
  <label id="vcf9-option">
    <input type="checkbox" id="vcf9-check"/> Check VCF 9 Compatibility (Broadcom Compatibility Guide)
  </label>
  <button class="btn" id="generate-btn" disabled onclick="generate()">
    Generate Excalidraw Diagram
  </button>
  <div id="status"></div>
</div>

<div id="preview-section" hidden>
  <div class="preview-header">
    <h2>Diagram Preview</h2>
    <button id="download-btn" class="btn-outline">Download .excalidraw</button>
  </div>
  <div id="excalidraw-mount"></div>
</div>

<footer>
  Built with ‚ô• by Florian Casse &nbsp;¬∑&nbsp;
  Open the generated <code>.excalidraw</code> file at
  <a href="https://excalidraw.com" target="_blank">excalidraw.com</a>
  <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme"></button>
</footer>

<script>
// ‚îÄ‚îÄ Color palettes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PALETTES = [
  { zone_bg:"#E3F5F4", zone_stroke:"#2DC4B8", hdr_bg:"#2DC4B8", hdr_text:"#FFFFFF",
    cluster_bg:"#EAF8F7", cluster_stroke:"#2DC4B8", host_bg:"#FFFFFF", host_stroke:"#7DD4CE", host_text:"#0D4A45" },
  { zone_bg:"#E8F0FB", zone_stroke:"#1A5DAD", hdr_bg:"#1A5DAD", hdr_text:"#FFFFFF",
    cluster_bg:"#EDF3FD", cluster_stroke:"#1A5DAD", host_bg:"#FFFFFF", host_stroke:"#5B9BD5", host_text:"#0D3B78" },
  { zone_bg:"#E8F5EE", zone_stroke:"#1E8449", hdr_bg:"#1E8449", hdr_text:"#FFFFFF",
    cluster_bg:"#EDF7F1", cluster_stroke:"#1E8449", host_bg:"#FFFFFF", host_stroke:"#52BE80", host_text:"#145A32" },
  { zone_bg:"#EDE8F7", zone_stroke:"#5B3DAB", hdr_bg:"#5B3DAB", hdr_text:"#FFFFFF",
    cluster_bg:"#F3F0FB", cluster_stroke:"#5B3DAB", host_bg:"#FFFFFF", host_stroke:"#9B7DD4", host_text:"#3D2580" },
  { zone_bg:"#EAF0F0", zone_stroke:"#2E7D8C", hdr_bg:"#2E7D8C", hdr_text:"#FFFFFF",
    cluster_bg:"#EEF4F5", cluster_stroke:"#2E7D8C", host_bg:"#FFFFFF", host_stroke:"#6BB8C4", host_text:"#1A4D56" },
  { zone_bg:"#FAE8E8", zone_stroke:"#C0392B", hdr_bg:"#C0392B", hdr_text:"#FFFFFF",
    cluster_bg:"#FDF0F0", cluster_stroke:"#C0392B", host_bg:"#FFFFFF", host_stroke:"#E57373", host_text:"#7B241C" },
];

// ‚îÄ‚îÄ Layout constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ZONE_W    = 780;
const COLS      = 3;
const HOST_W    = 230;
const HOST_H    = 120;
const CLUSTER_H = 28;
const HEADER_H  = 65;
const PAD       = 12;
const COL_GAP   = 10;
const ROW_GAP   = 8;
const ZONE_GAP  = 30;
const CANVAS_X  = 60;
const CANVAS_Y  = 60;

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function uid() { return crypto.randomUUID(); }

function findCol(headers, candidates) {
  const map = {};
  headers.forEach(h => map[h.toLowerCase()] = h);
  for (const c of candidates) {
    if (c.toLowerCase() in map) return map[c.toLowerCase()];
  }
  return null;
}

function safe(val) {
  if (val === null || val === undefined) return '';
  return String(val).trim();
}

function fmtPct(v) {
  const f = parseFloat(v);
  if (!isNaN(f)) return `${Math.round(f)}%`;
  return (v && String(v).trim()) ? String(v).trim() : '‚Äî';
}

// ‚îÄ‚îÄ VCF 9 Compatibility (Broadcom Compatibility Guide) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _hclCache = null;

async function fetchHcl() {
  if (_hclCache) return _hclCache;
  const res = await fetch('vcf9_hcl.json');
  if (!res.ok) throw new Error('Failed to load VCF 9 compatibility data');
  _hclCache = await res.json();
  return _hclCache;
}

function buildVcf9Lookup(hclData) {
  // Build a Map of normalised model ‚Üí release list for version-aware lookup
  const models = new Map();
  for (const entry of hclData) {
    models.set(entry.m.trim().toLowerCase(), entry.r);
  }
  return models;
}

function normalizeModel(model) {
  // Strip common vendor prefixes that RVTools sometimes includes
  return model.replace(/^(Dell\s+(Inc\.?\s*)?|HPE?\s+|Lenovo\s+|Cisco\s+|Fujitsu\s+)/i, '').trim();
}

function vcf9Label(releases) {
  const versions = releases.map(r => r.replace(/^ESXi\s*/i, '')).sort();
  return '\u2705 VCF ' + versions.join(' + ') + ' Ready';
}

function checkVcf9Compat(model, lookup) {
  if (!model) return { status: 'unknown', label: '\u26A0\uFE0F VCF9 ?' };
  const norm = normalizeModel(model).toLowerCase();
  // Exact match
  if (lookup.has(norm)) return { status: 'compatible', label: vcf9Label(lookup.get(norm)) };
  // Check if any BCG model is contained in the host model or vice-versa
  for (const [hclModel, releases] of lookup) {
    if (norm.includes(hclModel) || hclModel.includes(norm))
      return { status: 'compatible', label: vcf9Label(releases) };
  }
  return { status: 'incompatible', label: '\u274C Not VCF9 Ready' };
}

let xlsxLoadPromise = null;

function ensureXlsxLoaded() {
  if (window.XLSX) return Promise.resolve(window.XLSX);
  if (xlsxLoadPromise) return xlsxLoadPromise;
  xlsxLoadPromise = new Promise((resolve, reject) => {
    const timeout = setTimeout(() => {
      reject(new Error('Timed out loading XLSX parser ‚Äî check your network connection'));
    }, 15000);
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js';
    script.async = true;
    script.onload = () => { clearTimeout(timeout); resolve(window.XLSX); };
    script.onerror = () => { clearTimeout(timeout); reject(new Error('Failed to load XLSX parser')); };
    document.head.appendChild(script);
  });
  return xlsxLoadPromise;
}

// ‚îÄ‚îÄ RVTools parser ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseRvtools(wb, siteName) {
  const sheetMap = {};
  wb.SheetNames.forEach(s => sheetMap[s.toLowerCase()] = s);

  const vhostKey = sheetMap['vhost'];
  if (!vhostKey) throw new Error(`No vHost sheet found in "${siteName}"`);

  const rows = XLSX.utils.sheet_to_json(wb.Sheets[vhostKey], { defval: '' });
  if (!rows.length) throw new Error(`vHost sheet is empty in "${siteName}"`);

  const headers = Object.keys(rows[0]);
  const colHost    = findCol(headers, ['VM Host', 'Host', 'DNS Name', 'Name']);
  const colCluster = findCol(headers, ['Cluster', 'Cluster Name']);
  const colModel   = findCol(headers, ['Model', 'Hardware Model']);
  const colEsxi    = findCol(headers, ['ESX Version', 'ESXi Version', 'Version']);
  const colVms     = findCol(headers, ['# VMs', 'VMs', 'Number of VMs', '#VMs']);
  const colCpu     = findCol(headers, ['CPU usage %', 'CPU %', 'CPU Usage %', 'CPU%']);
  const colMem     = findCol(headers, ['Memory usage %', 'Mem %', 'Memory %', 'Mem%']);
  const colSvc     = findCol(headers, ['Service Tag', 'Serial Number', 'SN']);

  const hosts = [];
  for (const row of rows) {
    const hostname = colHost ? safe(row[colHost]) : '';
    if (!hostname) continue;

    let esxi = colEsxi ? safe(row[colEsxi]) : '';
    const m = esxi.match(/(\d+\.\d+\.\d+)/);
    if (m) esxi = m[1];

    hosts.push({
      hostname,
      cluster:  colCluster ? (safe(row[colCluster]) || 'Default') : 'Default',
      model:    colModel   ? safe(row[colModel])  : '',
      esxi,
      vms:      colVms     ? (safe(row[colVms])   || '0') : '0',
      cpu:      fmtPct(colCpu ? safe(row[colCpu]) : ''),
      mem:      fmtPct(colMem ? safe(row[colMem]) : ''),
      svc:      colSvc     ? safe(row[colSvc])    : '',
    });
  }

  // vSource ‚Üí vCenter version
  let vcenterVersion = '';
  const vsKey = sheetMap['vsource'];
  if (vsKey) {
    const vsRows = XLSX.utils.sheet_to_json(wb.Sheets[vsKey], { defval: '' });
    if (vsRows.length) {
      const vsHeaders = Object.keys(vsRows[0]);
      const colFn = findCol(vsHeaders, ['Fullname', 'Full Name', 'Version', 'Name']);
      if (colFn) {
        for (const row of vsRows) {
          const s = safe(row[colFn]);
          let mv = s.match(/vCenter Server\s+(\d+\.\d+\.\d+)/i);
          if (!mv) mv = s.match(/(\d+\.\d+\.\d+\.\d+)/);
          if (mv) { vcenterVersion = mv[1]; break; }
        }
      }
    }
  }

  const clusters = {};
  for (const h of hosts) {
    (clusters[h.cluster] ||= []).push(h);
  }

  return {
    site_name: siteName,
    clusters,
    vcenter_version: vcenterVersion,
    total_hosts: hosts.length,
    total_vms: hosts.reduce((s, h) => s + (parseInt(h.vms) || 0), 0),
  };
}

// ‚îÄ‚îÄ LiveOptics parser ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseLiveOptics(wb, siteName) {
  const sheetMap = {};
  wb.SheetNames.forEach(s => sheetMap[s.toLowerCase()] = s);

  const hostsKey = sheetMap['esx hosts'];
  if (!hostsKey) throw new Error(`No "ESX Hosts" sheet found in "${siteName}"`);

  const hostsRows = XLSX.utils.sheet_to_json(wb.Sheets[hostsKey], { defval: '' });
  if (!hostsRows.length) throw new Error(`"ESX Hosts" sheet is empty in "${siteName}"`);

  // Build performance lookup: Host Name ‚Üí perf row
  const perfMap = {};
  const perfKey = sheetMap['esx performance'];
  if (perfKey) {
    for (const row of XLSX.utils.sheet_to_json(wb.Sheets[perfKey], { defval: '' })) {
      const h = safe(row['Host']);
      if (h) perfMap[h] = row;
    }
  }

  // vCenter version from first host row
  let vcenterVersion = '';
  const vcStr = safe(hostsRows[0]['vCenter']);
  const vcMatch = vcStr.match(/(\d+\.\d+\.\d+)/);
  if (vcMatch) vcenterVersion = vcMatch[1];

  const hosts = [];
  for (const row of hostsRows) {
    const hostname = safe(row['Host Name']);
    if (!hostname) continue;

    // ESXi version from OS field e.g. "VMware ESXi 8.0.2 build-23305546"
    let esxi = '';
    const osMatch = safe(row['OS']).match(/(\d+\.\d+\.\d+)/);
    if (osMatch) esxi = osMatch[1];

    const perf = perfMap[hostname] || {};
    hosts.push({
      hostname,
      cluster:  safe(row['Cluster'])       || 'Default',
      model:    safe(row['Model']),
      esxi,
      vms:      safe(row['Guest VM Count']) || '0',
      cpu:      fmtPct(safe(perf['Average CPU %'])),
      mem:      fmtPct(safe(perf['Average Memory %'])),
      svc:      safe(row['Serial No']),
    });
  }

  const clusters = {};
  for (const h of hosts) (clusters[h.cluster] ||= []).push(h);

  return {
    site_name: siteName,
    clusters,
    vcenter_version: vcenterVersion,
    total_hosts: hosts.length,
    total_vms: hosts.reduce((s, h) => s + (parseInt(h.vms) || 0), 0),
  };
}

// ‚îÄ‚îÄ Auto-detect format and parse ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseFile(arrayBuffer, siteName) {
  const wb = XLSX.read(arrayBuffer, { type: 'array' });
  const lower = wb.SheetNames.map(s => s.toLowerCase());
  if (lower.includes('vhost'))     return parseRvtools(wb, siteName);
  if (lower.includes('esx hosts')) return parseLiveOptics(wb, siteName);
  throw new Error(`"${siteName}" is not a recognised RVTools or LiveOptics export`);
}

// ‚îÄ‚îÄ Excalidraw element builder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function randomSeed() { return (Math.random() * 0xFFFFFF) >>> 0; }

function makeRect(id, x, y, w, h, bg, stroke, text = '', fontSize = 12,
                  bold = false, textColor = '#1A1A2E', vAlign = 'middle', rounded = 8) {
  const el = {
    id, type: 'rectangle', x, y, width: w, height: h, angle: 0,
    strokeColor: stroke, backgroundColor: bg, fillStyle: 'solid',
    strokeWidth: 1, strokeStyle: 'solid', roughness: 0, opacity: 100,
    groupIds: [], roundness: { type: 3, value: rounded },
    seed: randomSeed(), version: 1, versionNonce: 0, isDeleted: false,
    boundElements: [], updated: 1, link: null, locked: false,
  };
  const elements = [el];
  if (text) {
    const txtId = uid();
    el.boundElements.push({ type: 'text', id: txtId });
    elements.push({
      id: txtId, type: 'text', x, y, width: w, height: h, angle: 0,
      strokeColor: textColor, backgroundColor: 'transparent',
      fillStyle: 'solid', strokeWidth: 1, strokeStyle: 'solid',
      roughness: 0, opacity: 100, groupIds: [], seed: randomSeed(),
      version: 1, versionNonce: 0, isDeleted: false,
      boundElements: [], updated: 1, link: null, locked: false,
      text,
      fontSize: bold ? fontSize + 1 : fontSize,
      fontFamily: bold ? 1 : 3,
      textAlign: 'center', verticalAlign: vAlign,
      containerId: id, originalText: text, autoResize: true, lineHeight: 1.25,
    });
  }
  return elements;
}

// ‚îÄ‚îÄ Excalidraw diagram generator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateExcalidraw(sites, vcf9Enabled) {
  const elements = [];
  let xCursor = CANVAS_X;
  const hostH = vcf9Enabled ? 140 : HOST_H;

  for (let idx = 0; idx < sites.length; idx++) {
    const { site_name, clusters, vcenter_version, total_hosts, total_vms } = sites[idx];
    const p = PALETTES[idx % PALETTES.length];

    // Zone height
    let innerH = HEADER_H + PAD;
    for (const chosts of Object.values(clusters)) {
      innerH += CLUSTER_H + PAD + Math.ceil(chosts.length / COLS) * (hostH + ROW_GAP);
    }
    const zoneH = innerH + PAD;
    const y0 = CANVAS_Y;

    // Site zone background
    elements.push(...makeRect(uid(), xCursor, y0, ZONE_W, zoneH,
      p.zone_bg, p.zone_stroke, '', 12, false, '#1A1A2E', 'middle', 12));

    // Site header
    let hdrText = `${site_name}  ¬∑  ${total_hosts} hosts  ¬∑  ${total_vms} VMs`;
    if (vcenter_version) hdrText += `\nvCenter ${vcenter_version}`;
    elements.push(...makeRect(uid(), xCursor, y0, ZONE_W, HEADER_H,
      p.hdr_bg, p.hdr_bg, hdrText, 14, true, p.hdr_text, 'middle', 10));

    // Clusters
    let cy = y0 + HEADER_H + PAD;
    for (const [cname, chosts] of Object.entries(clusters)) {
      elements.push(...makeRect(uid(), xCursor + PAD, cy, ZONE_W - 2*PAD, CLUSTER_H,
        p.cluster_bg, p.cluster_stroke, cname, 11, true, p.zone_stroke, 'middle', 4));
      cy += CLUSTER_H + PAD;

      const rows = Math.ceil(chosts.length / COLS);
      chosts.forEach((h, i) => {
        const hx = xCursor + PAD + (i % COLS) * (HOST_W + COL_GAP);
        const hy = cy + Math.floor(i / COLS) * (hostH + ROW_GAP);
        const lines = [
          h.hostname,
          h.model || '‚Äî',
          h.svc ? `SVC: ${h.svc}` : 'SVC: ‚Äî',
          h.esxi ? `ESXi ${h.esxi}` : 'ESXi ‚Äî',
          `VMs:${h.vms}  CPU:${h.cpu}  Mem:${h.mem}`,
        ];
        if (vcf9Enabled && h.vcf9) lines.push(h.vcf9.label);
        const label = lines.join('\n');

        const stroke = (vcf9Enabled && h.vcf9 && h.vcf9.status === 'incompatible')
          ? '#E57373' : p.host_stroke;
        elements.push(...makeRect(uid(), hx, hy, HOST_W, hostH,
          p.host_bg, stroke, label, 9, false, p.host_text, 'middle', 6));
      });

      cy += rows * (hostH + ROW_GAP) + PAD;
    }

    xCursor += ZONE_W + ZONE_GAP;
  }

  // VCF9 legend
  if (vcf9Enabled) {
    const legendX = xCursor;
    const legendY = CANVAS_Y;
    const legendW = 220;
    const legendH = 90;
    const legendText = 'VCF 9 Compatibility\n\u2705 VCF x.x Ready\n\u274C Not VCF9 Ready\n\u26A0\uFE0F VCF9 ? ‚Äî model unknown';
    elements.push(...makeRect(uid(), legendX, legendY, legendW, legendH,
      '#FFF9E6', '#D4A017', legendText, 9, false, '#4A4A00', 'middle', 8));
  }

  return { type: 'excalidraw', version: 2, source: 'https://excalidraw.com',
           elements, appState: { gridSize: null, viewBackgroundColor: '#F4F5F7' }, files: {} };
}

// ‚îÄ‚îÄ UI logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const dropZone  = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const fileList  = document.getElementById('file-list');
const genBtn    = document.getElementById('generate-btn');
const status    = document.getElementById('status');

let files = [];

function setStatus(text, type) {
  status.innerHTML = '';
  if (type === 'loading') {
    const spinner = document.createElement('span');
    spinner.className = 'spinner';
    status.appendChild(spinner);
    status.appendChild(document.createTextNode(' ' + text));
  } else if (type) {
    const span = document.createElement('span');
    span.className = type;
    span.textContent = text;
    status.appendChild(span);
  } else {
    status.textContent = text;
  }
}

function guessName(filename) {
  return filename.replace(/\.xlsx$/i, '').replace(/[_-]/g, ' ').trim();
}

function renderList() {
  fileList.innerHTML = '';
  files.forEach((item, i) => {
    const row = document.createElement('div');
    row.className = 'file-row';

    const icon = document.createElement('span');
    icon.className = 'file-icon';
    icon.textContent = 'üìÑ';

    const name = document.createElement('span');
    name.className = 'file-name';
    name.title = item.file.name;
    name.textContent = item.file.name;

    const input = document.createElement('input');
    input.className = 'site-input';
    input.type = 'text';
    input.value = item.name;
    input.placeholder = 'Site name';
    input.addEventListener('input', () => { files[i].name = input.value; });

    const btn = document.createElement('button');
    btn.className = 'remove-btn';
    btn.title = 'Remove';
    btn.textContent = '‚úï';
    btn.addEventListener('click', () => removeFile(i));

    row.append(icon, name, input, btn);
    fileList.appendChild(row);
  });
  genBtn.disabled = files.length === 0;
}

function addFiles(newFiles) {
  for (const f of newFiles) {
    if (f.name.endsWith('.xlsx') && !files.find(x => x.file.name === f.name))
      files.push({ file: f, name: guessName(f.name) });
  }
  renderList();
  status.textContent = '';
}

function removeFile(i) { files.splice(i, 1); renderList(); }

fileInput.addEventListener('change', () => addFiles(fileInput.files));
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.classList.remove('drag-over'); addFiles(e.dataTransfer.files);
});

function readFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror = () => reject(new Error(`Failed to read ${file.name}`));
    reader.readAsArrayBuffer(file);
  });
}

// ‚îÄ‚îÄ Theme toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function () {
  const root    = document.documentElement;
  const btn     = document.getElementById('theme-toggle');
  const mq      = window.matchMedia('(prefers-color-scheme: dark)');

  function activeTheme() {
    const explicit = root.getAttribute('data-theme');
    if (explicit) return explicit;
    return mq.matches ? 'dark' : 'light';
  }

  function applyTheme(theme) {
    root.setAttribute('data-theme', theme);
    btn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    document.dispatchEvent(new CustomEvent('theme-changed', { detail: { theme } }));
  }

  // Restore saved preference, or follow system
  const saved = localStorage.getItem('dmi-theme');
  if (saved) {
    applyTheme(saved);
  } else {
    btn.textContent = mq.matches ? '‚òÄÔ∏è' : 'üåô';
  }

  btn.addEventListener('click', () => {
    const next = activeTheme() === 'dark' ? 'light' : 'dark';
    localStorage.setItem('dmi-theme', next);
    applyTheme(next);
  });

  // Track system changes when no explicit override is saved
  mq.addEventListener('change', () => {
    if (!localStorage.getItem('dmi-theme')) {
      btn.textContent = mq.matches ? '‚òÄÔ∏è' : 'üåô';
      document.dispatchEvent(new CustomEvent('theme-changed', { detail: { theme: activeTheme() } }));
    }
  });
})();

async function generate() {
  if (!files.length) return;
  genBtn.disabled = true;
  setStatus('Generating diagram‚Ä¶', 'loading');

  try {
    await ensureXlsxLoaded();
    const sites = [];
    for (const item of files) {
      const buf = await readFile(item.file);
      sites.push(parseFile(buf, item.name || item.file.name));
    }

    const vcf9Enabled = document.getElementById('vcf9-check').checked;
    let vcf9Lookup = null;
    if (vcf9Enabled) {
      try {
        setStatus('Loading VCF 9 compatibility data‚Ä¶', 'loading');
        const hclData = await fetchHcl();
        vcf9Lookup = buildVcf9Lookup(hclData);
      } catch (e) {
        setStatus('Warning: Could not load VCF 9 data ‚Äî continuing without VCF9 check', 'err');
        vcf9Lookup = null;
      }
    }

    if (vcf9Enabled && vcf9Lookup) {
      for (const site of sites) {
        for (const chosts of Object.values(site.clusters)) {
          for (const h of chosts) {
            h.vcf9 = checkVcf9Compat(h.model, vcf9Lookup);
          }
        }
      }
    }

    const doc = generateExcalidraw(sites, vcf9Enabled && !!vcf9Lookup);
    window.__excalidrawDoc = doc;
    document.dispatchEvent(new CustomEvent('diagram-ready'));
    setStatus('‚úì Diagram ready ‚Äî see preview below', 'ok');
  } catch (e) {
    setStatus('Error: ' + e.message, 'err');
  } finally {
    genBtn.disabled = false;
  }
}
</script>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19",
    "react/jsx-runtime": "https://esm.sh/react@19/jsx-runtime",
    "react-dom": "https://esm.sh/react-dom@19",
    "react-dom/client": "https://esm.sh/react-dom@19/client"
  }
}
</script>
<script type="module">
let root = null;
let excalidrawLoadPromise = null;
let ReactLib = null;
let createRootFn = null;
let ExcalidrawLib = null;

function ensureExcalidrawStyles() {
  if (document.querySelector('link[data-excalidraw-css="true"]')) return;
  const link = document.createElement('link');
  link.rel = 'stylesheet';
  link.href = 'https://esm.sh/@excalidraw/excalidraw@0.18.0/dist/dev/index.css';
  link.setAttribute('data-excalidraw-css', 'true');
  document.head.appendChild(link);
}

async function ensureExcalidrawLoaded() {
  if (ExcalidrawLib && ReactLib && createRootFn) return;
  if (excalidrawLoadPromise) {
    await excalidrawLoadPromise;
    return;
  }

  excalidrawLoadPromise = Promise.race([
    (async () => {
      window.EXCALIDRAW_ASSET_PATH = 'https://esm.sh/@excalidraw/excalidraw@0.18.0/dist/prod/';
      ensureExcalidrawStyles();
      const [reactMod, reactDomMod, excalidrawMod] = await Promise.all([
        import('react'),
        import('react-dom/client'),
        import('https://esm.sh/@excalidraw/excalidraw@0.18.0/dist/dev/index.js?external=react,react-dom'),
      ]);
      ReactLib = reactMod.default;
      createRootFn = reactDomMod.createRoot;
      ExcalidrawLib = excalidrawMod;
    })(),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error('Timed out loading Excalidraw ‚Äî check your network connection')), 20000)
    ),
  ]);

  await excalidrawLoadPromise;
}

function excalidrawTheme() {
  return document.documentElement.getAttribute('data-theme') === 'dark' ||
    (!document.documentElement.getAttribute('data-theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)
    ? 'dark' : 'light';
}

async function renderDiagram() {
  const doc = window.__excalidrawDoc;
  if (!doc) return;
  await ensureExcalidrawLoaded();
  const mount = document.getElementById('excalidraw-mount');
  if (root) root.unmount();
  root = createRootFn(mount);
  root.render(ReactLib.createElement(ExcalidrawLib.Excalidraw, {
    initialData: { elements: doc.elements, appState: doc.appState, scrollToContent: true },
    viewModeEnabled: true,
    theme: excalidrawTheme(),
  }));
}

document.addEventListener('diagram-ready', () => {
  const section = document.getElementById('preview-section');
  section.hidden = false;
  section.scrollIntoView({ behavior: 'smooth', block: 'start' });
  renderDiagram().catch((e) => {
    const status = document.getElementById('status');
    setStatus('Error loading preview: ' + e.message, 'err');
  });
});

document.addEventListener('theme-changed', () => {
  renderDiagram().catch(() => {});
});

document.getElementById('download-btn').addEventListener('click', () => {
  const doc = window.__excalidrawDoc;
  if (!doc) return;
  const blob = new Blob([JSON.stringify(doc, null, 2)], { type: 'application/json' });
  const a = Object.assign(document.createElement('a'), {
    href: URL.createObjectURL(blob),
    download: 'vmware_infrastructure.excalidraw',
  });
  a.click();
  URL.revokeObjectURL(a.href);
});
</script>
</body>
</html>
